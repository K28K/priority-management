<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Priority Management System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f8fafc;
            color: #1f2937;
        }

        /* Modern SaaS Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar - 260px */
        .sidebar {
            width: 260px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .sidebar-logo {
            font-size: 18px;
            font-weight: 700;
            color: #7c3aed;
        }

        .sidebar-nav {
            flex: 1;
            padding: 12px 0;
        }

        .nav-item {
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: #f9fafb;
            color: #1f2937;
        }

        .nav-item.active {
            background: #f5f3ff;
            color: #7c3aed;
            border-left-color: #7c3aed;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Top Bar */
        .top-bar {
            height: 64px;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Modern Pills/Buttons */
        .pill-group {
            display: flex;
            gap: 8px;
        }

        .pill {
            padding: 8px 16px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            background: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pill:hover {
            background: #f9fafb;
        }

        .pill.active {
            background: #7c3aed;
            color: white;
            border-color: #7c3aed;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #7c3aed;
            color: white;
        }

        .btn-primary:hover {
            background: #6d28d9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.25);
        }

        .btn-secondary {
            background: white;
            border: 1px solid #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #f9fafb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* Content Section */
        .content-section {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Modern Cards */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #1f2937;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #e5e7eb;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            color: #7c3aed;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Alerts */
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            align-items: start;
            font-size: 14px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: 12px 14px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }

        th {
            background: #f9fafb;
            font-weight: 600;
            color: #1f2937;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: #f9fafb;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-purple {
            background: #f5f3ff;
            color: #7c3aed;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #9ca3af;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .close-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        /* Process Flow */
        .process-flow {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
            overflow-x: auto;
            padding: 4px;
        }

        .flow-stage {
            flex: 1;
            min-width: 140px;
            text-align: center;
            padding: 20px 16px;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .flow-stage.active {
            background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
            color: white;
            border-color: #7c3aed;
            transform: scale(1.03);
            box-shadow: 0 4px 16px rgba(124, 58, 237, 0.3);
        }

        .flow-number {
            width: 36px;
            height: 36px;
            background: #e5e7eb;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .flow-stage.active .flow-number {
            background: white;
            color: #7c3aed;
        }

        .flow-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .flow-subtitle {
            font-size: 12px;
            opacity: 0.8;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Filters Bar */
        .filters-bar {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 16px;
            align-items: center;
            border: 1px solid #e5e7eb;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-label {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
        }

        /* Priority editing */
        .priority-edit-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .priority-display {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .invoice-number-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .invoice-number-display {
            font-weight: 600;
            color: #1f2937;
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 80px;
            }
            .sidebar-header,
            .nav-item span {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">üéØ Priority System</div>
            </div>
            <div class="sidebar-nav">
                <div class="nav-item active" onclick="showSection('overview')">
                    <span>üìä</span>
                    <span>Overview</span>
                </div>
                <div class="nav-item" onclick="showSection('submit')">
                    <span>‚ûï</span>
                    <span>Submit Tasks</span>
                </div>
                <div class="nav-item" onclick="showSection('view')">
                    <span>üìã</span>
                    <span>View All Tasks</span>
                </div>
                <div class="nav-item" onclick="showSection('prioritize')">
                    <span>üéØ</span>
                    <span>Prioritize</span>
                </div>
                <div class="nav-item" onclick="showSection('review')">
                    <span>üîç</span>
                    <span>Product Review</span>
                </div>
                <div class="nav-item" onclick="showSection('track')">
                    <span>üìà</span>
                    <span>Track Delivery</span>
                </div>
                <div class="nav-item" onclick="showSection('dashboard')">
                    <span>üìâ</span>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="showSection('revenue')">
                    <span>üí∞</span>
                    <span>Revenue</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="top-bar-left">
                    <div class="pill-group">
                        <div class="pill active" id="current-date-display"></div>
                        <div class="pill" id="phase-display"></div>
                    </div>
                </div>
                <div class="top-bar-right">
                    <input type="date" class="form-input" id="simulated-date" onchange="updateSimulatedDate()" style="width: auto;">
                    <button class="btn btn-secondary btn-small" onclick="resetToToday()">Reset Date</button>
                    <button class="btn btn-primary btn-small" onclick="generate6MonthTest()">üß™ Test Data</button>
                    <button class="btn btn-danger btn-small" onclick="clearAllData()">Clear All</button>
                </div>
            </div>

            <!-- Content Sections -->
            <div id="sections-container">
                <!-- Overview -->
                <div id="overview" class="content-section active">
                    <h1 style="font-size: 28px; font-weight: 800; margin-bottom: 8px;">Process Overview</h1>
                    <p style="color: #6b7280; margin-bottom: 32px;">Track your priority management workflow</p>

                    <div class="process-flow">
                        <div class="flow-stage" id="stage-1">
                            <div class="flow-number">1</div>
                            <div class="flow-title">Submit</div>
                            <div class="flow-subtitle">Day 1-25</div>
                        </div>
                        <div class="flow-stage" id="stage-2">
                            <div class="flow-number">2</div>
                            <div class="flow-title">Prioritize</div>
                            <div class="flow-subtitle">Day 18-25</div>
                        </div>
                        <div class="flow-stage" id="stage-3">
                            <div class="flow-number">3</div>
                            <div class="flow-title">Review</div>
                            <div class="flow-subtitle">Day 26-1st</div>
                        </div>
                        <div class="flow-stage" id="stage-4">
                            <div class="flow-number">4</div>
                            <div class="flow-title">Development</div>
                            <div class="flow-subtitle">Full Month</div>
                        </div>
                        <div class="flow-stage" id="stage-5">
                            <div class="flow-number">5</div>
                            <div class="flow-title">Complete</div>
                            <div class="flow-subtitle">Ongoing</div>
                        </div>
                    </div>

                    <div id="overview-stats"></div>
                </div>

                <!-- Other sections will be populated -->
                <div id="submit" class="content-section"></div>
                <div id="view" class="content-section"></div>
                <div id="prioritize" class="content-section"></div>
                <div id="review" class="content-section"></div>
                <div id="track" class="content-section"></div>
                <div id="dashboard" class="content-section"></div>
                <div id="revenue" class="content-section"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Modal</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        let tasks = [];
        let simulatedDate = null;

        function getCurrentDate() {
            return simulatedDate ? new Date(simulatedDate) : new Date();
        }

        function updateSimulatedDate() {
            const dateInput = document.getElementById('simulated-date').value;
            simulatedDate = dateInput || null;
            updateUI();
        }

        function resetToToday() {
            simulatedDate = null;
            document.getElementById('simulated-date').value = '';
            updateUI();
        }

        function init() {
            loadData();
            const today = getCurrentDate();
            document.getElementById('simulated-date').value = today.toISOString().split('T')[0];
            updateUI();
        }

        function updateUI() {
            updateTopBar();
            updateProcessFlow();
            renderAllSections();
        }

        function updateTopBar() {
            const today = getCurrentDate();
            const day = today.getDate();
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            document.getElementById('current-date-display').textContent = 
                `${monthNames[today.getMonth()]} ${day}, ${today.getFullYear()}`;

            let phase = '';
            if (day >= 1 && day <= 17) phase = 'üìù Submit Phase';
            else if (day >= 18 && day <= 25) phase = 'üéØ Prioritize Phase';
            else if (day >= 26 || day === 1) phase = 'üîç Review Phase';
            else phase = '‚öôÔ∏è Development Phase';
            
            document.getElementById('phase-display').textContent = phase;
        }

        function updateProcessFlow() {
            const day = getCurrentDate().getDate();
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`stage-${i}`)?.classList.remove('active');
            }

            if (day >= 1 && day <= 17) document.getElementById('stage-1')?.classList.add('active');
            else if (day >= 18 && day <= 25) document.getElementById('stage-2')?.classList.add('active');
            else if (day >= 26 || day === 1) document.getElementById('stage-3')?.classList.add('active');
            else document.getElementById('stage-4')?.classList.add('active');
        }

        function renderAllSections() {
            renderSubmit();
            renderView();
            renderPrioritize();
            renderReview();
            renderTrack();
            renderDashboard();
            renderRevenue();
            renderOverview();
        }

        // DUE TO LENGTH CONSTRAINTS, I'LL PROVIDE THE CORE FIXES IN A CONTINUATION...
        // This is Part 1 of the complete system. The file structure is ready.
        // Let me continue with the actual implementation...

        function saveData() {
            localStorage.setItem('priority-system-v4', JSON.stringify(tasks));
        }

        function loadData() {
            const saved = localStorage.getItem('priority-system-v4');
            if (saved) {
                tasks = JSON.parse(saved);
            }
        }

        function clearAllData() {
            if (confirm('Clear all data?')) {
                tasks = [];
                saveData();
                updateUI();
            }
        }

        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(section)?.classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');
            
            updateUI();
        }

        function openModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function exportToCSV(data, filename) {
            if (data.length === 0) {
                alert('No data to export');
                return;
            }

            const keys = Object.keys(data[0]);
            const csv = [
                keys.join(','),
                ...data.map(row => keys.map(key => JSON.stringify(row[key] || '')).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Render functions - implementing all fixes

        function renderSubmit() {
            const today = getCurrentDate();
            const day = today.getDate();
            const month = today.getMonth();
            const year = today.getFullYear();
            
            const nextMonth = new Date(year, month + 1, 1);
            const nextMonthName = nextMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const currentMonthName = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            let html = `
                <h1 style="font-size: 28px; font-weight: 800; margin-bottom: 8px;">Submit New Task</h1>
                <p style="color: #6b7280; margin-bottom: 32px;">Add tasks for prioritization or ad-hoc review</p>

                <div class="card">
                    <form id="task-form" onsubmit="submitTask(event)">
                        <div class="form-group" style="margin-bottom: 24px;">
                            <label class="form-label">Target Development Month *</label>
                            <div style="display: flex; gap: 16px; margin-top: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="target-type" value="next-planned" checked>
                                    <span>${nextMonthName} (Planned - will be prioritized)</span>
                                </label>
                                ${day <= 25 ? `
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="target-type" value="current-adhoc">
                                    <span>${currentMonthName} (Ad-Hoc - direct to Product)</span>
                                </label>
                                ` : ''}
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Task Name *</label>
                                <input type="text" class="form-input" id="task-name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Client Name *</label>
                                <input type="text" class="form-input" id="client-name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Client Type *</label>
                                <select class="form-select" id="client-type" required>
                                    <option value="">Select...</option>
                                    <option value="Trophy Win">Trophy Win</option>
                                    <option value="Platinum">Platinum</option>
                                    <option value="Gold">Gold</option>
                                    <option value="SMB">SMB</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Task Type *</label>
                                <select class="form-select" id="task-type" required>
                                    <option value="">Select...</option>
                                    <option value="Onboarding">Onboarding</option>
                                    <option value="Retention">Retention</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Description *</label>
                            <textarea class="form-textarea" id="task-description" required></textarea>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Impact *</label>
                                <select class="form-select" id="task-impact" required>
                                    <option value="">Select...</option>
                                    <option value="Delight Feature">Delight Feature</option>
                                    <option value="Churn Threat">Churn Threat</option>
                                    <option value="Onboarding Requirement">Onboarding Requirement</option>
                                    <option value="Business Requirement">Business Requirement</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Revenue Type *</label>
                                <select class="form-select" id="revenue-type" required>
                                    <option value="">Select...</option>
                                    <option value="MRR">MRR</option>
                                    <option value="CR">CR</option>
                                    <option value="NA">NA</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount ($)</label>
                                <input type="number" class="form-input" id="revenue-amount" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">CSM Name *</label>
                                <input type="text" class="form-input" id="csm-name" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ASANA Link</label>
                            <input type="url" class="form-input" id="asana-link">
                        </div>

                        <button type="submit" class="btn btn-primary">Submit Task</button>
                    </form>
                </div>
            `;
            
            document.getElementById('submit').innerHTML = html;
        }

        function submitTask(event) {
            event.preventDefault();
            
            const today = getCurrentDate();
            const targetType = document.querySelector('input[name="target-type"]:checked').value;
            
            let targetMonth, plannedStatus, targetMonthKey;
            
            if (targetType === 'current-adhoc') {
                targetMonth = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                targetMonthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                plannedStatus = 'Ad-Hoc';
            } else {
                const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                targetMonth = nextMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                targetMonthKey = `${nextMonth.getFullYear()}-${String(nextMonth.getMonth() + 1).padStart(2, '0')}`;
                plannedStatus = 'Planned';
            }

            const task = {
                id: Date.now() + Math.random(),
                taskName: document.getElementById('task-name').value,
                clientName: document.getElementById('client-name').value,
                clientType: document.getElementById('client-type').value,
                taskType: document.getElementById('task-type').value,
                description: document.getElementById('task-description').value,
                impact: document.getElementById('task-impact').value,
                revenueType: document.getElementById('revenue-type').value,
                revenueAmount: parseFloat(document.getElementById('revenue-amount').value) || null,
                csmName: document.getElementById('csm-name').value,
                asanaLink: document.getElementById('asana-link').value,
                targetMonth: targetMonth,
                targetMonthKey: targetMonthKey,
                plannedStatus: plannedStatus,
                submittedDate: today.toISOString(),
                broughtForward: false
            };

            tasks.push(task);
            saveData();
            document.getElementById('task-form').reset();
            alert('‚úÖ Task submitted successfully!');
            updateUI();
        }

        // FIX #1: View only shows submitted tasks, no status field shown here
        function renderView() {
            const today = getCurrentDate();
            const day = today.getDate();
            
            // FIX #5: Month filter
            const uniqueMonths = [...new Set(tasks.map(t => t.targetMonthKey))].sort().reverse();
            
            let html = `
                <h1 style="font-size: 28px; font-weight: 800; margin-bottom: 8px;">All Submitted Tasks</h1>
                <p style="color: #6b7280; margin-bottom: 32px;">View and manage task submissions</p>

                <div class="filters-bar">
                    <div class="filter-group">
                        <label class="filter-label">Month:</label>
                        <select class="form-select" id="view-month-filter" onchange="renderView()" style="width: auto;">
                            <option value="">All Months</option>
                            ${uniqueMonths.map(m => {
                                const [y, mo] = m.split('-');
                                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                return `<option value="${m}">${monthNames[parseInt(mo) - 1]} ${y}</option>`;
                            }).join('')}
                        </select>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="exportViewData()">üì• Export CSV</button>
                </div>
            `;

            const selectedMonth = document.getElementById('view-month-filter')?.value || '';
            let filteredTasks = tasks;
            if (selectedMonth) {
                filteredTasks = tasks.filter(t => t.targetMonthKey === selectedMonth);
            }

            if (filteredTasks.length === 0) {
                html += '<div class="empty-state"><div class="empty-state-icon">üì≠</div><h3>No tasks found</h3></div>';
            } else {
                html += `
                    <div class="card">
                        <table>
                            <thead>
                                <tr>
                                    <th>Task</th>
                                    <th>Client</th>
                                    <th>Type</th>
                                    <th>Target Month</th>
                                    <th>Priority</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredTasks.map(task => `
                                    <tr>
                                        <td><strong>${task.taskName}</strong></td>
                                        <td>${task.clientName}<br><span class="badge badge-info">${task.clientType}</span></td>
                                        <td><span class="badge badge-${task.plannedStatus === 'Planned' ? 'success' : 'warning'}">${task.plannedStatus}</span></td>
                                        <td>${task.targetMonth}${task.broughtForward ? '<br><span class="badge badge-warning">BROUGHT FORWARD</span>' : ''}</td>
                                        <td>${task.finalPriority || '-'}</td>
                                        <td>${getTaskActions(task, day)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            document.getElementById('view').innerHTML = html;
        }

        function getTaskActions(task, currentDay) {
            let actions = '';
            if ((task.plannedStatus === 'Planned' && currentDay <= 25) || task.plannedStatus === 'Ad-Hoc') {
                actions += `<button class="btn btn-secondary btn-small" onclick="editTask(${task.id})">Edit</button>`;
            }
            if (task.plannedStatus === 'Planned' && currentDay <= 25) {
                actions += ` <button class="btn btn-danger btn-small" onclick="deleteTask(${task.id})">Delete</button>`;
            }
            return actions || '<em style="color: #9ca3af;">View only</em>';
        }

        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            openModal('Edit Task', `
                <form onsubmit="saveEditedTask(event, ${taskId})">
                    <div class="form-group">
                        <label class="form-label">Task Name</label>
                        <input type="text" class="form-input" id="edit-task-name" value="${task.taskName}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Client Name</label>
                        <input type="text" class="form-input" id="edit-client-name" value="${task.clientName}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="edit-description" required>${task.description}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            `);
        }

        function saveEditedTask(event, taskId) {
            event.preventDefault();
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            task.taskName = document.getElementById('edit-task-name').value;
            task.clientName = document.getElementById('edit-client-name').value;
            task.description = document.getElementById('edit-description').value;
            
            saveData();
            closeModal();
            updateUI();
            alert('‚úÖ Task updated!');
        }

        function deleteTask(taskId) {
            if (confirm('Delete this task?')) {
                tasks = tasks.filter(t => t.id !== taskId);
                saveData();
                updateUI();
            }
        }

        function exportViewData() {
            const selectedMonth = document.getElementById('view-month-filter')?.value || '';
            let data = tasks;
            if (selectedMonth) {
                data = tasks.filter(t => t.targetMonthKey === selectedMonth);
            }
            exportToCSV(data.map(t => ({
                task: t.taskName,
                client: t.clientName,
                type: t.plannedStatus,
                month: t.targetMonth,
                priority: t.finalPriority || ''
            })), 'submitted_tasks');
        }

        // FIX #2: Prioritize shows all tasks, editable until Day 25
        function renderPrioritize() {
            const today = getCurrentDate();
            const day = today.getDate();
            
            let html = `
                <h1 style="font-size: 28px; font-weight: 800; margin-bottom: 8px;">Prioritize & Rank</h1>
                <p style="color: #6b7280; margin-bottom: 32px;">Assign priorities and rank tasks (Day 18-25)</p>
            `;
            
            if (day < 18 || day > 25) {
                html += `
                    <div class="alert alert-warning">
                        <span>‚è∞</span>
                        <div><strong>Prioritization Window Closed.</strong> Active only Day 18-25. Current day: ${day}</div>
                    </div>
                `;
                document.getElementById('prioritize').innerHTML = html;
                return;
            }
            
            const needsPriority = tasks.filter(t => 
                t.plannedStatus === 'Planned' && 
                !t.broughtForward
            );
            
            if (needsPriority.length === 0) {
                html += '<div class="alert alert-success"><span>‚úÖ</span><div>No tasks to prioritize</div></div>';
                document.getElementById('prioritize').innerHTML = html;
                return;
            }
            
            html += `
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Client</th>
                                <th>Priority</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${needsPriority.map(task => `
                                <tr>
                                    <td>${task.taskName}</td>
                                    <td>${task.clientName}</td>
                                    <td>
                                        ${task.finalPriority ? `
                                            <div class="priority-edit-container">
                                                <span class="badge badge-purple" id="priority-display-${task.id}">${task.finalPriority}</span>
                                                <button class="btn btn-secondary btn-small" onclick="editPriority(${task.id})">Change</button>
                                            </div>
                                        ` : `
                                            <input type="number" id="priority-${task.id}" min="1" placeholder="Enter #" class="form-input" style="width: 100px;">
                                        `}
                                    </td>
                                    <td>
                                        ${!task.finalPriority ? `
                                            <button class="btn btn-primary btn-small" onclick="assignPriority(${task.id})">Assign</button>
                                        ` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('prioritize').innerHTML = html;
        }

        function assignPriority(taskId) {
            const priorityInput = document.getElementById(`priority-${taskId}`);
            const priorityNum = parseInt(priorityInput.value);
            
            if (!priorityNum || priorityNum < 1) {
                alert('Please enter a valid priority number');
                return;
            }
            
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.finalPriority = `P${priorityNum}`;
                task.prioritizationComplete = true;
                task.prioritizedDate = getCurrentDate().toISOString();
                saveData();
                renderPrioritize();
                alert(`‚úÖ Priority P${priorityNum} assigned`);
            }
        }

        function editPriority(taskId) {
            const newPriority = prompt('Enter new priority number:');
            if (!newPriority) return;
            
            const priorityNum = parseInt(newPriority);
            if (priorityNum < 1) {
                alert('Invalid priority number');
                return;
            }
            
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.finalPriority = `P${priorityNum}`;
                saveData();
                renderPrioritize();
                alert('‚úÖ Priority updated');
            }
        }

        // FIX #4: Product Review with month dropdown for historical viewing
        function renderReview() {
            const today = getCurrentDate();
            const day = today.getDate();
            
            const uniqueMonths = [...new Set(tasks.filter(t => t.prioritizationComplete || t.plannedStatus === 'Ad-Hoc').map(t => t.targetMonthKey))].sort().reverse();
            
            let html = `
                <h1 style="font-size: 28px; font-weight: 800; margin-bottom: 8px;">Product Review</h1>
                <p style="color: #6b7280; margin-bottom: 32px;">Mark tasks for development (Day 26 - 1st)</p>

                <div class="filters-bar">
                    <div class="filter-group">
                        <label class="filter-label">Month:</label>
                        <select class="form-select" id="review-month-filter" onchange="renderReview()" style="width: auto;">
                            ${uniqueMonths.map(m => {
                                const [y, mo] = m.split('-');
                                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                return `<option value="${m}">${monthNames[parseInt(mo) - 1]} ${y}</option>`;
                            }).join('')}
                        </select>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="exportReviewData()">üì• Export CSV</button>
                </div>
            `;

            const selectedMonth = document.getElementById('review-month-filter')?.value || uniqueMonths[0];
            
            const forReview = tasks.filter(t => 
                t.targetMonthKey === selectedMonth &&
                (t.prioritizationComplete || t.plannedStatus === 'Ad-Hoc' || t.broughtForward)
            );

            const pending = forReview.filter(t => !t.productFeasibility);
            const reviewed = forReview.filter(t => t.productFeasibility);
            
            if (pending.length > 0) {
                const broughtForward = pending.filter(t => t.broughtForward);
                const prioritized = pending.filter(t => t.prioritizationComplete && !t.broughtForward);
                const adhoc = pending.filter(t => t.plannedStatus === 'Ad-Hoc');

                if (broughtForward.length > 0) {
                    html += `
                        <div class="card">
                            <div class="card-title" style="color: #f59e0b;">‚ö†Ô∏è Brought Forward Tasks (Auto P1)</div>
                            ${renderReviewTable(broughtForward, day >= 26 || day === 1)}
                        </div>
                    `;
                }

                if (prioritized.length > 0) {
                    html += `
                        <div class="card">
                            <div class="card-title">üéØ Prioritized Tasks</div>
                            ${renderReviewTable(prioritized, day >= 26 || day === 1)}
                        </div>
                    `;
                }

                if (adhoc.length > 0) {
                    html += `
                        <div class="card">
                            <div class="card-title">üî• Ad-Hoc Tasks</div>
                            ${renderReviewTable(adhoc, day >= 26 || day === 1)}
                        </div>
                    `;
                }
            }

            if (reviewed.length > 0) {
                html += `
                    <div class="card">
                        <div class="card-title">‚úÖ Reviewed Tasks (${reviewed.length})</div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Task</th>
                                    <th>Client</th>
                                    <th>Decision</th>
                                    <th>Delivery Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reviewed.map(task => `
                                    <tr>
                                        <td>${task.taskName}</td>
                                        <td>${task.clientName}</td>
                                        <td><span class="badge badge-${task.productFeasibility === 'YES' ? 'success' : task.productFeasibility === 'MAYBE' ? 'warning' : 'danger'}">${task.productFeasibility}</span></td>
                                        <td>${task.tentativeDeliveryDate || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            document.getElementById('review').innerHTML = html;
        }

        function renderReviewTable(taskList, canReview) {
            return `
                <table>
                    <thead>
                        <tr>
                            <th>Task</th>
                            <th>Client</th>
                            <th>Priority</th>
                            ${canReview ? '<th>Mark Decision</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${taskList.map(task => `
                            <tr>
                                <td><strong>${task.taskName}</strong><br><small style="color: #6b7280;">${task.description.substring(0, 100)}...</small></td>
                                <td>${task.clientName}<br><span class="badge badge-info">${task.clientType}</span></td>
                                <td>${task.finalPriority || (task.broughtForward ? 'P1' : '-')}</td>
                                ${canReview ? `
                                    <td>
                                        <button class="btn btn-success btn-small" onclick="markProduct(${task.id}, 'YES')">‚úì YES</button>
                                        <button class="btn btn-warning btn-small" onclick="markProduct(${task.id}, 'MAYBE')">? MAYBE</button>
                                        <button class="btn btn-danger btn-small" onclick="markProduct(${task.id}, 'NO')">‚úó NO</button>
                                    </td>
                                ` : ''}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function markProduct(taskId, decision) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            if (decision === 'YES') {
                openModal('Mark Task as YES', `
                    <form onsubmit="saveProductDecision(event, ${taskId}, 'YES')">
                        <div class="form-group">
                            <label class="form-label">Tentative Delivery Month *</label>
                            <input type="text" class="form-input" id="delivery-month" placeholder="e.g., March 2024" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tentative Delivery Date *</label>
                            <input type="date" class="form-input" id="delivery-date" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Confirm YES</button>
                    </form>
                `);
            } else {
                task.productFeasibility = decision;
                task.productReviewDate = getCurrentDate().toISOString();
                saveData();
                updateUI();
                alert(`‚úÖ Task marked as ${decision}`);
            }
        }

        function saveProductDecision(event, taskId, decision) {
            event.preventDefault();
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            task.productFeasibility = decision;
            task.tentativeDeliveryMonth = document.getElementById('delivery-month').value;
            task.tentativeDeliveryDate = document.getElementById('delivery-date').value;
            task.productReviewDate = getCurrentDate().toISOString();
            task.status = 'in-development';
            
            saveData();
            closeModal();
            updateUI();
            alert('‚úÖ Task marked as YES and moved to development');
        }

        function exportReviewData() {
            const selectedMonth = document.getElementById('review-month-filter')?.value;
            const data = tasks.filter(t => t.targetMonthKey === selectedMonth);
            exportToCSV(data.map(t => ({
                task: t.taskName,
                client: t.clientName,
                priority: t.finalPriority || '',
                decision: t.productFeasibility || 'Pending'
            })), 'product_review');
        }

        // FIX #3 & #6: Track Delivery with Reopen button and fixed overdue logic
        function renderTrack() {
            const inDev = tasks.filter(t => t.productFeasibility === 'YES');
            
            let html = `
                <h1 style="font-size: 28px; font-weight: 800; margin-bottom: 8px;">Track Delivery</h1>
                <p style="color: #6b7280; margin-bottom: 32px;">Monitor development progress</p>

                <div class="filters-bar">
                    <button class="btn btn-secondary btn-small" onclick="exportTrackData()">üì• Export CSV</button>
                    <button class="btn btn-warning" onclick="closeMonth()">üîÑ Close Month & Carry Forward</button>
                </div>
            `;
            
            if (inDev.length === 0) {
                html += '<div class="empty-state"><div class="empty-state-icon">üìä</div><h3>No tasks in development</h3></div>';
                document.getElementById('track').innerHTML = html;
                return;
            }
            
            html += `
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Client</th>
                                <th>Tentative Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${inDev.map(task => {
                                // FIX #6: Correct overdue logic
                                const today = getCurrentDate();
                                const tentativeDate = task.tentativeDeliveryDate ? new Date(task.tentativeDeliveryDate) : null;
                                const isOverdue = tentativeDate && tentativeDate < today && task.status !== 'completed';
                                
                                return `
                                    <tr${isOverdue ? ' style="background: #fee2e2;"' : ''}>
                                        <td><strong>${task.taskName}</strong>${task.broughtForward ? '<br><span class="badge badge-warning">BROUGHT FORWARD</span>' : ''}</td>
                                        <td>${task.clientName}</td>
                                        <td>${task.tentativeDeliveryDate || 'Not set'}${isOverdue ? '<br><span class="badge badge-danger">OVERDUE</span>' : ''}</td>
                                        <td><span class="badge badge-${task.status === 'completed' ? 'success' : 'warning'}">${task.status}</span></td>
                                        <td>
                                            ${task.status !== 'completed' ? `
                                                <button class="btn btn-primary btn-small" onclick="markComplete(${task.id})">Mark Complete</button>
                                            ` : `
                                                <button class="btn btn-secondary btn-small" onclick="reopenTask(${task.id})">Reopen</button>
                                            `}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('track').innerHTML = html;
        }

        function markComplete(taskId) {
            openModal('Mark Task Complete', `
                <form onsubmit="saveCompleteTask(event, ${taskId})">
                    <div class="form-group">
                        <label class="form-label">Actual Delivery Date *</label>
                        <input type="date" class="form-input" id="actual-date" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Confirm Complete</button>
                </form>
            `);
        }

        function saveCompleteTask(event, taskId) {
            event.preventDefault();
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            task.status = 'completed';
            task.completedDate = getCurrentDate().toISOString();
            task.actualDeliveryDate = document.getElementById('actual-date').value;
            
            saveData();
            closeModal();
            updateUI();
            alert('‚úÖ Task marked as completed!');
        }

        // FIX #3: Reopen completed task
        function reopenTask(taskId) {
            if (!confirm('Reopen this completed task?')) return;
            
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.status = 'in-development';
                delete task.completedDate;
                delete task.actualDeliveryDate;
                saveData();
                updateUI();
                alert('‚úÖ Task reopened');
            }
        }

        function closeMonth() {
            if (!confirm('Close this month and carry forward incomplete tasks?')) return;
            
            const today = getCurrentDate();
            const currentMonthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            
            const incomplete = tasks.filter(t => 
                t.targetMonthKey === currentMonthKey &&
                t.productFeasibility === 'YES' &&
                t.status !== 'completed'
            );
            
            const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
            const nextMonthKey = `${nextMonth.getFullYear()}-${String(nextMonth.getMonth() + 1).padStart(2, '0')}`;
            const nextMonthName = nextMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            incomplete.forEach(task => {
                const broughtTask = {
                    ...task,
                    id: Date.now() + Math.random(),
                    targetMonth: nextMonthName,
                    targetMonthKey: nextMonthKey,
                    broughtForward: true,
                    broughtForwardFrom: currentMonthKey,
                    originalTaskId: task.id,
                    finalPriority: 'P1',
                    prioritizationComplete: true
                };
                
                tasks.push(broughtTask);
            });
            
            saveData();
            updateUI();
            alert(`‚úÖ Month closed! ${incomplete.length} task(s) brought forward to ${nextMonthName}`);
        }

        function exportTrackData() {
            const data = tasks.filter(t => t.productFeasibility === 'YES');
            exportToCSV(data.map(t => ({
                task: t.taskName,
                client: t.clientName,
                tentativeDate: t.tentativeDeliveryDate || '',
                status: t.status,
                actualDate: t.actualDeliveryDate || ''
            })), 'track_delivery');
        }

        function renderDashboard() {
            const byMonth = {};
            tasks.forEach(task => {
                const key = task.targetMonthKey;
                if (!byMonth[key]) {
                    byMonth[key] = {
                        month: task.targetMonth,
                        submitted: 0,
                        broughtForward: 0,
                        adhoc: 0,
                        prioritized: 0,
                        accepted: 0,
                        completed: 0,
                        totalValue: 0,
                        completedValue: 0
                    };
                }
                
                if (task.broughtForward) byMonth[key].broughtForward++;
                else if (task.plannedStatus === 'Ad-Hoc') byMonth[key].adhoc++;
                else byMonth[key].submitted++;
                
                if (task.prioritizationComplete) byMonth[key].prioritized++;
                if (task.productFeasibility === 'YES') byMonth[key].accepted++;
                if (task.status === 'completed') byMonth[key].completed++;
                
                byMonth[key].totalValue += task.revenueAmount || 0;
                if (task.status === 'completed') byMonth[key].completedValue += task.revenueAmount || 0;
            });
            
            let html = `
                <h1 style="font-size: 28px; font-weight: 800; margin-bottom: 8px;">Dashboard</h1>
                <p style="color: #6b7280; margin-bottom: 32px;">Analytics and insights</p>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${tasks.length}</div>
                        <div class="stat-label">Total Tasks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${tasks.filter(t => t.prioritizationComplete).length}</div>
                        <div class="stat-label">Prioritized</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${tasks.filter(t => t.productFeasibility === 'YES').length}</div>
                        <div class="stat-label">Accepted</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${tasks.filter(t => t.status === 'completed').length}</div>
                        <div class="stat-label">Completed</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Month-by-Month Breakdown</div>
                    <div style="margin-bottom: 16px;">
                        <button class="btn btn-secondary btn-small" onclick="exportDashboardData()">üì• Export CSV</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>New</th>
                                <th>Brought Fwd</th>
                                <th>Ad-Hoc</th>
                                <th>Total</th>
                                <th>Accepted</th>
                                <th>Completed</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.keys(byMonth).sort().map(key => {
                                const m = byMonth[key];
                                const total = m.submitted + m.broughtForward + m.adhoc;
                                return `
                                    <tr>
                                        <td><strong>${m.month}</strong></td>
                                        <td>${m.submitted}</td>
                                        <td><span class="badge badge-warning">${m.broughtForward}</span></td>
                                        <td><span class="badge badge-info">${m.adhoc}</span></td>
                                        <td><strong>${total}</strong></td>
                                        <td>${m.accepted}</td>
                                        <td>${m.completed}</td>
                                        <td>$${m.completedValue.toLocaleString()} / $${m.totalValue.toLocaleString()}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('dashboard').innerHTML = html;
        }

        function exportDashboardData() {
            const data = tasks.map(t => ({
                month: t.targetMonth,
                task: t.taskName,
                type: t.plannedStatus,
                broughtForward: t.broughtForward ? 'Yes' : 'No',
                priority: t.finalPriority || '',
                accepted: t.productFeasibility || '',
                status: t.status || 'submitted',
                value: t.revenueAmount || 0
            }));
            exportToCSV(data, 'dashboard_data');
        }

        // FIX #7: Revenue with locked invoice number + edit/clear
        function renderRevenue() {
            const completed = tasks.filter(t => t.status === 'completed' && t.revenueAmount);
            
            let html = `
                <h1 style="font-size: 28px; font-weight: 800; margin-bottom: 8px;">Revenue Assurance</h1>
                <p style="color: #6b7280; margin-bottom: 32px;">Track invoicing and payments</p>

                <div class="filters-bar">
                    <button class="btn btn-secondary btn-small" onclick="exportRevenueData()">üì• Export CSV</button>
                </div>
            `;
            
            if (completed.length === 0) {
                html += '<div class="empty-state"><div class="empty-state-icon">üí∞</div><h3>No completed tasks with revenue</h3></div>';
                document.getElementById('revenue').innerHTML = html;
                return;
            }
            
            const totalValue = completed.reduce((sum, t) => sum + (t.revenueAmount || 0), 0);
            const invoiceRequested = completed.filter(t => t.invoiceRequested).reduce((sum, t) => sum + (t.revenueAmount || 0), 0);
            const invoiced = completed.filter(t => t.invoiced).reduce((sum, t) => sum + (t.revenueAmount || 0), 0);
            
            html += `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">$${totalValue.toLocaleString()}</div>
                        <div class="stat-label">Total Value</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">$${invoiceRequested.toLocaleString()}</div>
                        <div class="stat-label">Invoice Requested</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">$${invoiced.toLocaleString()}</div>
                        <div class="stat-label">Invoiced</div>
                    </div>
                </div>

                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Client</th>
                                <th>Value</th>
                                <th>Invoice Request (CST)</th>
                                <th>Invoiced (Finance)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${completed.map(task => `
                                <tr>
                                    <td>${task.taskName}</td>
                                    <td>${task.clientName}</td>
                                    <td>$${task.revenueAmount.toLocaleString()}</td>
                                    <td>
                                        <input type="checkbox" ${task.invoiceRequested ? 'checked' : ''} onchange="toggleInvoiceRequest(${task.id}, this.checked)"> Requested
                                    </td>
                                    <td>
                                        ${renderInvoiceField(task)}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('revenue').innerHTML = html;
        }

        function renderInvoiceField(task) {
            if (task.invoiced && task.invoiceNumber) {
                return `
                    <div class="invoice-number-container">
                        <span class="invoice-number-display">${task.invoiceNumber}</span>
                        <button class="btn btn-secondary btn-small" onclick="editInvoiceNumber(${task.id})">Edit</button>
                        <button class="btn btn-danger btn-small" onclick="clearInvoice(${task.id})">Clear</button>
                    </div>
                `;
            } else {
                return `
                    <input type="checkbox" ${task.invoiced ? 'checked' : ''} onchange="toggleInvoiced(${task.id}, this.checked)"> Invoiced
                `;
            }
        }

        function toggleInvoiceRequest(taskId, checked) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.invoiceRequested = checked;
                saveData();
                renderRevenue();
            }
        }

        function toggleInvoiced(taskId, checked) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            if (checked) {
                const invoiceNum = prompt('Enter invoice number:');
                if (!invoiceNum) return;
                
                task.invoiced = true;
                task.invoiceNumber = invoiceNum;
            } else {
                task.invoiced = false;
                delete task.invoiceNumber;
            }
            
            saveData();
            renderRevenue();
        }

        function editInvoiceNumber(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const newNumber = prompt('Enter new invoice number:', task.invoiceNumber);
            if (newNumber) {
                task.invoiceNumber = newNumber;
                saveData();
                renderRevenue();
            }
        }

        function clearInvoice(taskId) {
            if (!confirm('Clear invoice information?')) return;
            
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.invoiced = false;
                delete task.invoiceNumber;
                saveData();
                renderRevenue();
            }
        }

        function exportRevenueData() {
            const data = tasks.filter(t => t.status === 'completed' && t.revenueAmount);
            exportToCSV(data.map(t => ({
                task: t.taskName,
                client: t.clientName,
                value: t.revenueAmount,
                invoiceRequested: t.invoiceRequested ? 'Yes' : 'No',
                invoiced: t.invoiced ? 'Yes' : 'No',
                invoiceNumber: t.invoiceNumber || ''
            })), 'revenue_assurance');
        }

        function renderOverview() {
            const today = getCurrentDate();
            const currentMonthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            const currentTasks = tasks.filter(t => t.targetMonthKey === currentMonthKey);
            
            const submitted = currentTasks.filter(t => !t.broughtForward && t.plannedStatus === 'Planned').length;
            const broughtForward = currentTasks.filter(t => t.broughtForward).length;
            const adhoc = currentTasks.filter(t => t.plannedStatus === 'Ad-Hoc').length;
            const accepted = currentTasks.filter(t => t.productFeasibility === 'YES').length;
            const completed = currentTasks.filter(t => t.status === 'completed').length;
            
            let html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${submitted}</div>
                        <div class="stat-label">New Submitted</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #f59e0b;">${broughtForward}</div>
                        <div class="stat-label">Brought Forward</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #3b82f6;">${adhoc}</div>
                        <div class="stat-label">Ad-Hoc</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #10b981;">${accepted}</div>
                        <div class="stat-label">Accepted</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #10b981;">${completed}</div>
                        <div class="stat-label">Completed</div>
                    </div>
                </div>
            `;
            
            document.getElementById('overview-stats').innerHTML = html;
        }

        function generate6MonthTest() {
            if (!confirm('Generate 6 months of test data?')) return;
            
            tasks = [];
            const startDate = new Date(2024, 0, 1);
            
            for (let monthIdx = 0; monthIdx < 6; monthIdx++) {
                const monthDate = new Date(startDate.getFullYear(), startDate.getMonth() + monthIdx, 1);
                const monthKey = `${monthDate.getFullYear()}-${String(monthDate.getMonth() + 1).padStart(2, '0')}`;
                const monthName = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                for (let i = 0; i < 25; i++) {
                    const isPlanned = i < 20;
                    const task = {
                        id: Date.now() + monthIdx * 1000 + i + Math.random(),
                        taskName: `Task ${i + 1} - ${monthName}`,
                        clientName: ['Acme Corp', 'TechStart', 'Global Solutions', 'Smart Systems'][i % 4],
                        clientType: ['Trophy Win', 'Platinum', 'Gold', 'SMB'][i % 4],
                        taskType: i % 2 === 0 ? 'Onboarding' : 'Retention',
                        description: `Test task ${i + 1} for ${monthName}`,
                        impact: ['Delight Feature', 'Churn Threat', 'Business Requirement'][i % 3],
                        revenueType: i % 3 === 0 ? 'NA' : (i % 2 === 0 ? 'MRR' : 'CR'),
                        revenueAmount: i % 3 === 0 ? null : (10 + i) * 1000,
                        csmName: 'Test CSM',
                        asanaLink: 'https://app.asana.com/test',
                        targetMonth: monthName,
                        targetMonthKey: monthKey,
                        plannedStatus: isPlanned ? 'Planned' : 'Ad-Hoc',
                        submittedDate: new Date(monthDate.getFullYear(), monthDate.getMonth(), isPlanned ? 15 : 27).toISOString(),
                        broughtForward: false
                    };
                    
                    if (isPlanned) {
                        task.finalPriority = `P${i + 1}`;
                        task.prioritizationComplete = true;
                    }
                    
                    if (isPlanned && Math.random() < 0.65) {
                        task.productFeasibility = 'YES';
                        task.status = 'in-development';
                        task.tentativeDeliveryDate = new Date(monthDate.getFullYear(), monthDate.getMonth(), 20).toISOString();
                        
                        if (Math.random() < 0.75) {
                            task.status = 'completed';
                            task.completedDate = new Date(monthDate.getFullYear(), monthDate.getMonth(), 28).toISOString();
                        }
                    } else if (isPlanned) {
                        task.productFeasibility = Math.random() < 0.5 ? 'NO' : 'MAYBE';
                    }
                    
                    tasks.push(task);
                }
                
                if (monthIdx < 5) {
                    const incomplete = tasks.filter(t => 
                        t.targetMonthKey === monthKey &&
                        t.productFeasibility === 'YES' &&
                        t.status !== 'completed'
                    );
                    
                    const nextMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 1);
                    const nextMonthKey = `${nextMonth.getFullYear()}-${String(nextMonth.getMonth() + 1).padStart(2, '0')}`;
                    const nextMonthName = nextMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    
                    incomplete.forEach(task => {
                        tasks.push({
                            ...task,
                            id: Date.now() + Math.random(),
                            targetMonth: nextMonthName,
                            targetMonthKey: nextMonthKey,
                            broughtForward: true,
                            broughtForwardFrom: monthKey,
                            originalTaskId: task.id,
                            finalPriority: 'P1',
                            prioritizationComplete: true
                        });
                    });
                }
            }
            
            saveData();
            updateUI();
            alert('‚úÖ Generated 6 months of test data!');
        }

        window.onload = init;
    </script>
</body>
</html>